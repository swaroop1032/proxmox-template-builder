// --- JENKINSFILE_BUILDER.TXT (FINAL CORRECTED VERSION) ---
pipeline {
    agent any

    tools {
        terraform 'Terraform' 
    }

    environment {
        // 1. Fetch credentials from Jenkins store (local pipeline variables)
        PM_TOKEN_ID_SECRET    = credentials('PROXMOX_API_TOKEN_ID')
        PM_TOKEN_SECRET_KEY   = credentials('PROXMOX_API_TOKEN_SECRET')
        
        // 2. Set API URL
        PM_API_URL_VALUE      = "https://192.168.31.180:8006/api2/json" 
        
        // 3. Template name for verification
        TF_VAR_template_name_new = "ubuntu-2204-cloudinit-template-swa"
    }
    
    parameters {
        string(name: 'PROXMOX_NODE', defaultValue: 'pve', description: 'The Proxmox node where the template will be created.')
        string(name: 'STORAGE_DISK', defaultValue: 'local-lvm', description: 'The storage pool for the template disk.')
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        
        stage('Terraform Init') {
            steps {
                bat 'terraform init -upgrade'
            }
        }

        stage('Create/Update Template') {
            steps {
                echo "Downloading Cloud Image and building template: ${env.TF_VAR_template_name_new}"
                
                // CRITICAL FIX: The required variables must be passed 
                // via -var flags to satisfy Terraform's plan stage AND via ENV VARS for the provider.
                withEnv([
                    // Passed to the BPG Provider for authentication
                    "PM_API_URL=${env.PM_API_URL_VALUE}",
                    "PM_TOKEN_ID=${env.PM_TOKEN_ID_SECRET}",
                    "PM_TOKEN_SECRET=${env.PM_TOKEN_SECRET_KEY}",
                    "PM_TLS_INSECURE=true" 
                ]) {
                    // Running the command with ALL required variables supplied via -var flags
                    bat """
                    terraform apply -auto-approve \\
                        -var=\"proxmox_node=${params.PROXMOX_NODE}\" \\
                        -var=\"storage_vm_disk=${params.STORAGE_DISK}\" \\
                        -var=\"pm_api_url=${env.PM_API_URL_VALUE}\" \\
                        -var=\"pm_api_token_id=${env.PM_TOKEN_ID_SECRET}\" \\
                        -var=\"pm_api_token_secret=${env.PM_TOKEN_SECRET_KEY}\"
                    """
                }
            }
        }
        
        stage('Verification') {
            steps {
                echo "Success! The template named '${env.TF_VAR_template_name_new}' is now available on Proxmox for cloning."
            }
        }
    }
}
