// --- Jenkinsfile_Builder.txt (FINAL CORRECTED VERSION) ---
pipeline {
    agent any

    tools {
        // This 'Terraform' must match the name you configure in Jenkins Global Tool Configuration
        terraform 'Terraform'
    }

    environment {
        // IMPORTANT: TF_VAR_ prefix makes these environment variables automatically
        // available as Terraform input variables (e.g., var.pm_api_token_id)

        // 1. Load secrets from Jenkins credentials store
        TF_VAR_pm_api_token_id    = credentials('PROXMOX_API_TOKEN_ID')
        TF_VAR_pm_api_token_secret = credentials('PROXMOX_API_TOKEN_SECRET')

        // 2. Set API URL
        TF_VAR_pm_api_url         = "https://192.168.31.180:8006/api2/json"
        
        // 3. Optional: Insecure flag for self-signed certs (if needed)
        TF_VAR_pm_tls_insecure    = "true"
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Terraform Init') {
            steps {
                echo "Initializing Terraform and installing telmate/proxmox..."
                bat 'terraform init -upgrade'
            }
        }

        stage('Terraform Apply') {
            steps {
                echo "Applying Terraform configuration using telmate/proxmox provider..."
                
                // Pass non-secret variables via -var flags
                bat 'terraform apply -auto-approve -var="proxmox_node=pve" -var="storage_vm_disk=local-lvm" -var="vm_template_name=ubuntu-2204-cloudinit-template" -var="ci_default_user=terraform"'
            }
        }

        stage('Verification') {
            steps {
                echo "Verification step skipped. Check Proxmox console for VM creation."
            }
        }
    }
}
