// --- Jenkinsfile_Builder.txt (Updated for telmate/proxmox authentication) ---
pipeline {
    agent any

    tools {
        // This 'Terraform' must match the name you configure in Jenkins Global Tool Configuration
        terraform 'Terraform'
    }

    environment {
        // Load secrets from Jenkins credentials store
        // The telmate provider REQUIRES these specific variable names for authentication.
        PM_API_TOKEN_ID     = credentials('PROXMOX_API_TOKEN_ID')
        PM_API_TOKEN_SECRET = credentials('PROXMOX_API_TOKEN_SECRET')

        // Other environment variables required by the provider
        PM_API_URL          = "https://192.168.31.180:8006/api2/json"
        PM_TLS_INSECURE     = "true" // Needed for self-signed certificates
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Terraform Init') {
            steps {
                // Initializes Terraform and downloads the new 'telmate/proxmox' provider
                bat 'terraform init -upgrade'
            }
        }

        stage('Terraform Apply') {
            steps {
                echo "Applying Terraform configuration using telmate/proxmox provider..."
                
                // Authentication is handled by the environment block above.
                // Only pass the variable defaults that don't need to be secret:
                bat 'terraform apply -auto-approve -var="proxmox_node=pve" -var="storage_vm_disk=local-lvm" -var="vm_template_name=ubuntu-2204-cloudinit-template-swa" -var="ci_default_user=terraform"'
            }
        }

        stage('Verification') {
            steps {
                echo "Verification stage skipped. Check Proxmox console for VM: ubuntu-vm-jenkins-XXXX"
            }
        }
    }
}
