// Jenkinsfile
pipeline {
    agent any // Runs on any available Jenkins agent

    tools {
        // This 'terraform' must match the name you configure in Jenkins Global Tool Configuration
        terraform 'Terraform'
    }

    environment {
        // Load secrets from Jenkins credentials store (must be configured as "Secret Text" or "Secret File")
        TF_VAR_pm_api_token_id    = credentials('PROXMOX_API_TOKEN_ID')
        TF_VAR_pm_api_token_secret = credentials('PROXMOX_API_TOKEN_SECRET')
        
        // General variables passed to Terraform
        TF_VAR_pm_api_url         = "https://192.168.31.180:8006/api2/json" // Your Proxmox API URL
        TF_VAR_proxmox_node       = "pve" // Your Proxmox node name
        
        // This IP must be able to host your preseed.cfg file!
        TF_VAR_preseed_url        = "http://192.168.31.200/preseed.cfg" 
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Template Build') {
            steps {
                // 1. Initialize Terraform and download the Proxmox provider
                sh 'terraform init -upgrade'
                
                // 2. Create an execution plan, passing in the required ISO file name
                // Note: The ISO must be present on the Proxmox storage already.
                sh 'terraform plan -out=tfplan -var="iso_file_name=local:iso/ubuntu-22.04.4-live-server-amd64.iso"'
            }
        }
        
        // Since the installation takes a long time, we set a high stage timeout.
        stage('Apply Template Build (25 Min Timeout)') {
            steps {
                timeout(time: 25, unit: 'MINUTES') { 
                    // This is where the long installation process occurs.
                    // The 'local-exec' will run after the Terraform timeout expires.
                    sh 'terraform apply -auto-approve tfplan'
                }
            }
        }
        
        stage('Cleanup (Destroy)') {
            steps {
                // If you want to delete the temporary VM if the template already exists,
                // you would run a separate destroy stage here. For initial template creation, 
                // we typically skip destroy.
                echo 'Template build complete. Manual check required for success.'
            }
        }
    }
}
