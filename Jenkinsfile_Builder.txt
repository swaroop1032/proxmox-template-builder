// --- JENKINSFILE_BUILDER.TXT (FINAL CORRECTED VERSION) ---
pipeline {
    agent any

    tools {
        terraform 'Terraform' 
    }

    environment {
        // 1. Fetch credentials from Jenkins store (local pipeline variables)
        PM_TOKEN_ID_SECRET    = credentials('PROXMOX_API_TOKEN_ID')
        PM_TOKEN_SECRET_KEY   = credentials('PROXMOX_API_TOKEN_SECRET')
        
        // 2. Set API URL
        PM_API_URL_VALUE      = "https://192.168.31.180:8006/api2/json" 
        
        // 3. Template name for verification
        TF_VAR_template_name_new = "ubuntu-2204-cloudinit-template"
    }
    
    parameters {
        string(name: 'PROXMOX_NODE', defaultValue: 'pve', description: 'The Proxmox node where the template will be created.')
        string(name: 'STORAGE_DISK', defaultValue: 'local-lvm', description: 'The storage pool for the template disk.')
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        
        stage('Terraform Init') {
            steps {
                bat 'terraform init -upgrade'
            }
        }

        stage('Create/Update Template') {
            steps {
                echo "Downloading Cloud Image and building template: ${env.TF_VAR_template_name_new}"
                
                // CRITICAL FIX: Use withEnv to map local variables to the 
                // environment variables that the bpg/proxmox provider expects.
                withEnv([
                    "PM_API_URL=${env.PM_API_URL_VALUE}",
                    "PM_TOKEN_ID=${env.PM_TOKEN_ID_SECRET}",
                    "PM_TOKEN_SECRET=${env.PM_TOKEN_SECRET_KEY}",
                    // The BPG provider usually defaults to secure TLS. 
                    // If you have self-signed certs, you might need to export:
                    "PM_TLS_INSECURE=true" 
                ]) {
                    // Running the command in the environment with the correct auth vars
                    bat "terraform apply -auto-approve -var=\"proxmox_node=${params.PROXMOX_NODE}\" -var=\"storage_vm_disk=${params.STORAGE_DISK}\""
                }
            }
        }
        
        stage('Verification') {
            steps {
                echo "Success! The template named '${env.TF_VAR_template_name_new}' is now available on Proxmox for cloning."
            }
        }
    }
}
